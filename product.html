<!doctype html>
<html lang="en" class="h-full">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>EcoFinds – Product</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="assets/css/styles.css" />
	<script>tailwind.config = { darkMode: 'class' };</script>
</head>
<body class="min-h-full bg-emerald-50/40 dark:bg-zinc-950 text-zinc-100">
	<div id="navbar"></div>
	<main class="container py-8">
		<div id="content" class="grid md:grid-cols-2 gap-6"></div>
	</main>
	<div id="footer"></div>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="assets/js/supabase.js"></script>
	<script src="assets/js/common.js"></script>
	<script src="assets/js/storage.js"></script>
	<script>
		function getId(){ const u=new URL(location.href); return u.searchParams.get('id'); }
		async function fetchProduct(id){
			const { data, error } = await sb.from('products').select('*').eq('id', id).single();
			if (error) { console.error(error); return null; }
			return data;
		}
		function render(p){
			if(!p){ document.getElementById('content').innerHTML = '<p>Not found.</p>'; return; }
			document.getElementById('content').innerHTML = `
				<div>
					<img src="${p.image||''}" alt="${p.title}" class="w-full h-80 object-cover rounded"/>
				</div>
				<div>
					<h1 class="text-2xl font-bold">${p.title}</h1>
					<div class="mt-1 text-zinc-400">${p.category||''} • Age: ${p.age||'-'}</div>
					<div class="mt-2 text-emerald-400 font-bold">₹${p.price}</div>
					<p class="mt-4 text-zinc-300">${p.description||''}</p>
					<div class="mt-4 flex flex-wrap gap-2">
						<button id="addCart" class="px-4 py-2 rounded bg-emerald-600 text-white">Add to Cart</button>
						<a href="checkout.html" id="buyNow" class="px-4 py-2 rounded bg-zinc-800">Buy Now</a>
						<button id="shareBtn" class="px-4 py-2 rounded bg-zinc-800">Share</button>
						<button id="reportBtn" class="px-4 py-2 rounded bg-red-700 text-white">Report</button>
					</div>
				</div>`;
			// Add to cart
			document.getElementById('addCart').addEventListener('click', () => {
				const cartItem = { 
					id: p.id, 
					title: p.title, 
					price: p.price, 
					image: p.image,
					category: p.category,
					seller_id: p.owner_id
				};
				window.eco.cart.add(cartItem);
				showToast('Item added to cart ✅');
			});
			// Share
			document.getElementById('shareBtn').addEventListener('click', async () => {
				const url = location.href;
				const text = `Check out this EcoFinds item: ${p.title}`;
				if (navigator.share) {
					try { await navigator.share({ title: p.title, text, url }); } catch {}
				} else {
					alert(`Share this link: ${url}`);
				}
			});
			// Report
			document.getElementById('reportBtn').addEventListener('click', async () => {
				const { error } = await sb.from('reports').insert({ product_id: p.id, reason: 'User report' });
				if (error) { alert('Failed to report'); console.error(error); }
				else { alert('Reported. Thank you!'); }
			});
		}
		function showToast(message) {
			const toast = document.createElement('div');
			toast.textContent = message;
			toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded shadow-lg z-50';
			document.body.appendChild(toast);
			setTimeout(() => toast.remove(), 2000);
		}
		(async function init(){
			const id = getId();
			if(!id){ document.getElementById('content').innerHTML = '<p>No id.</p>'; return; }
			const p = await fetchProduct(id);
			render(p);
		})();
	</script>
</body>
</html>
