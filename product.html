<!doctype html>
<html lang="en" class="h-full">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>EcoFinds – Product</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="assets/css/styles.css" />
	<script>
		tailwind.config = { 
			darkMode: 'class',
			theme: {
				extend: {
					colors: {
						eco: {
							green: '#2ECC71',
							dark: '#27AE60',
							gray: '#F8F9FA',
							text: '#2C3E50'
						}
					}
				}
			}
		};
	</script>
</head>
<body class="min-h-full bg-gray-50 text-gray-800" style="font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
	<div id="navbar"></div>
	
	<main class="container py-8">
		<div id="content" class="grid lg:grid-cols-2 gap-12"></div>
	</main>
	
	<div id="footer"></div>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="assets/js/supabase.js"></script>
	<script src="assets/js/common.js"></script>
	<script src="assets/js/storage.js"></script>
	<script>
		function getId(){ const u=new URL(location.href); return u.searchParams.get('id'); }
		async function fetchProduct(id){
			const { data, error } = await sb.from('products').select('*').eq('id', id).single();
			if (error) { console.error(error); return null; }
			return data;
		}
		function render(p){
			if(!p){ 
				document.getElementById('content').innerHTML = `
					<div class="col-span-2 text-center py-16">
						<div class="text-6xl mb-4">😞</div>
						<h2 class="text-2xl font-bold text-gray-800 mb-2">Product Not Found</h2>
						<p class="text-gray-600 mb-6">The product you're looking for doesn't exist or has been removed.</p>
						<a href="index.html" class="btn-primary">Back to Home</a>
					</div>
				`; 
				return; 
			}
			
			const isLoggedIn = window.eco?.auth?.isLoggedIn || false;
			const addCartClass = isLoggedIn ? "btn-primary" : "btn-primary opacity-50 cursor-not-allowed";
			const buyNowClass = isLoggedIn ? "btn-outline" : "btn-outline opacity-50 cursor-not-allowed";
			
			document.getElementById('content').innerHTML = `
				<!-- Product Image -->
				<div class="space-y-4">
					<div class="card bg-white overflow-hidden">
						<img src="${p.image || '/assets/images/placeholder.jpg'}" alt="${p.title}" class="w-full h-96 object-cover"/>
					</div>
					<div class="flex gap-2">
						<div class="w-20 h-20 bg-gray-200 rounded-lg overflow-hidden">
							<img src="${p.image || '/assets/images/placeholder.jpg'}" alt="${p.title}" class="w-full h-full object-cover"/>
						</div>
						<div class="w-20 h-20 bg-gray-200 rounded-lg overflow-hidden">
							<img src="${p.image || '/assets/images/placeholder.jpg'}" alt="${p.title}" class="w-full h-full object-cover"/>
						</div>
						<div class="w-20 h-20 bg-gray-200 rounded-lg overflow-hidden">
							<img src="${p.image || '/assets/images/placeholder.jpg'}" alt="${p.title}" class="w-full h-full object-cover"/>
						</div>
					</div>
				</div>
				
				<!-- Product Details -->
				<div class="space-y-6">
					<div>
						<h1 class="text-3xl font-bold text-gray-800 mb-2">${p.title}</h1>
						<div class="flex items-center gap-4 mb-4">
							<span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">${p.category || 'General'}</span>
							<span class="text-sm text-gray-500">Age: ${p.age || 'Not specified'}</span>
						</div>
						<div class="text-4xl font-bold text-green-500 mb-4">₹${p.price}</div>
						<p class="text-gray-600 leading-relaxed">${p.description || 'No description available.'}</p>
					</div>
					
					<!-- Action Buttons -->
					<div class="space-y-4">
						<div class="flex gap-4">
							<button id="addCart" class="${addCartClass} flex-1" ${!isLoggedIn ? 'disabled' : ''}>
								<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m0 0h8.5M17 18a2 2 0 100 4 2 2 0 000-4zM9 18a2 2 0 100 4 2 2 0 000-4z"></path>
								</svg>
								Add to Cart
							</button>
							<a href="checkout.html" id="buyNow" class="${buyNowClass} flex-1 text-center" ${!isLoggedIn ? 'onclick="return false;"' : ''}>
								<svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
								</svg>
								Message Seller
							</a>
						</div>
						
						<div class="flex gap-2">
							<button id="shareBtn" class="btn-outline flex-1">
								<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
								</svg>
								Share
							</button>
							<button id="reportBtn" class="btn-outline flex-1 text-red-600 border-red-600 hover:bg-red-600 hover:text-white">
								<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
								</svg>
								Report
							</button>
						</div>
					</div>
					
					<!-- Product Info -->
					<div class="card bg-white p-6">
						<h3 class="font-semibold text-gray-800 mb-4">Product Information</h3>
						<div class="space-y-3">
							<div class="flex justify-between">
								<span class="text-gray-600">Category:</span>
								<span class="font-medium">${p.category || 'General'}</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600">Age:</span>
								<span class="font-medium">${p.age || 'Not specified'}</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600">Condition:</span>
								<span class="font-medium">Good</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600">Location:</span>
								<span class="font-medium">${p.city || 'Not specified'}</span>
							</div>
						</div>
					</div>
				</div>
			`;
			
			// Add to cart
			document.getElementById('addCart').addEventListener('click', () => {
				if (!window.eco.auth.requireAuth('add to cart')) return;
				
				const cartItem = { 
					id: p.id, 
					title: p.title, 
					price: p.price, 
					image: p.image,
					category: p.category,
					seller_id: p.owner_id
				};
				window.eco.cart.add(cartItem);
				showToast('✅ Item added to cart');
			});
			
			// Buy Now
			document.getElementById('buyNow').addEventListener('click', (e) => {
				if (!window.eco.auth.requireAuth('proceed to checkout')) {
					e.preventDefault();
					return false;
				}
			});
			
			// Share
			document.getElementById('shareBtn').addEventListener('click', async () => {
				const url = location.href;
				const text = `Check out this EcoFinds item: ${p.title}`;
				if (navigator.share) {
					try { await navigator.share({ title: p.title, text, url }); } catch {}
				} else {
					// Fallback: copy to clipboard
					try {
						await navigator.clipboard.writeText(url);
						showToast('🔗 Link copied to clipboard');
					} catch {
						alert(`Share this link: ${url}`);
					}
				}
			});
			
			// Report
			document.getElementById('reportBtn').addEventListener('click', async () => {
				if (!confirm('Are you sure you want to report this item?')) return;
				
				try {
					const { error } = await sb.from('reports').insert({ product_id: p.id, reason: 'User report' });
					if (error) throw error;
					showToast('🚨 Item reported. Thank you!');
				} catch (error) {
					console.error('Report error:', error);
					showToast('❌ Failed to report item');
				}
			});
		}
		
		function showToast(message) {
			const toast = document.createElement('div');
			toast.textContent = message;
			toast.className = 'toast';
			document.body.appendChild(toast);
			setTimeout(() => toast.remove(), 3000);
		}
		(async function init(){
			// Wait for auth state to be checked
			await window.eco.auth.checkAuth();
			
			const id = getId();
			if(!id){ document.getElementById('content').innerHTML = '<p>No id.</p>'; return; }
			const p = await fetchProduct(id);
			render(p);
			
			// Listen for auth state changes
			document.addEventListener('eco-auth-changed', () => {
				render(p);
			});
		})();
	</script>
</body>
</html>
