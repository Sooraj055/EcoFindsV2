<!doctype html>
<html lang="en" class="h-full">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>EcoFinds ‚Äì Category</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="assets/css/styles.css" />
	<script>
		tailwind.config = { 
			darkMode: 'class',
			theme: {
				extend: {
					colors: {
						eco: {
							green: '#2ECC71',
							dark: '#27AE60',
							gray: '#F8F9FA',
							text: '#2C3E50'
						}
					}
				}
			}
		};
	</script>
</head>
<body class="min-h-full bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100" style="font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
	<div id="navbar"></div>
	
	<main class="container py-8">
		<div class="max-w-6xl mx-auto">
			<!-- Category Header -->
			<div class="mb-8">
				<h1 id="categoryTitle" class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">Category</h1>
				<p id="categoryDescription" class="text-gray-600 dark:text-gray-400">Browse products in this category</p>
			</div>
			
			<div class="grid lg:grid-cols-4 gap-8">
				<!-- Filters Sidebar -->
				<div class="lg:col-span-1">
					<div class="card bg-white dark:bg-gray-800 p-6 sticky top-24">
						<h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-4">Filters</h3>
						
						<!-- Sort Options -->
						<div class="mb-6">
							<h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Sort By</h4>
							<div class="space-y-2">
								<label class="flex items-center">
									<input type="radio" name="sort" value="new" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">New Arrivals</span>
								</label>
								<label class="flex items-center">
									<input type="radio" name="sort" value="age" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">Age (youngest first)</span>
								</label>
								<label class="flex items-center">
									<input type="radio" name="sort" value="rating" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">Seller Rating</span>
								</label>
								<label class="flex items-center">
									<input type="radio" name="sort" value="location" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">Nearest Location</span>
								</label>
							</div>
						</div>
						
						<!-- Price Range -->
						<div class="mb-6">
							<h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Price Range</h4>
							<div class="space-y-2">
								<label class="flex items-center">
									<input type="radio" name="price" value="0-500" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">‚Çπ0 - ‚Çπ500</span>
								</label>
								<label class="flex items-center">
									<input type="radio" name="price" value="500-1000" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">‚Çπ500 - ‚Çπ1000</span>
								</label>
								<label class="flex items-center">
									<input type="radio" name="price" value="1000-5000" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">‚Çπ1000 - ‚Çπ5000</span>
								</label>
								<label class="flex items-center">
									<input type="radio" name="price" value="5000+" class="text-green-500 focus:ring-green-500">
									<span class="ml-2 text-sm text-gray-600 dark:text-gray-400">‚Çπ5000+</span>
								</label>
							</div>
						</div>
						
						<!-- Clear Filters -->
						<button id="clearFilters" class="w-full btn-outline text-sm">Clear All Filters</button>
					</div>
				</div>
				
				<!-- Category Results -->
				<div class="lg:col-span-3">
					<div id="categoryResults" class="space-y-4 mb-8">
						<!-- Results will be populated here -->
					</div>
					
					<div id="noResults" class="text-center py-16 hidden">
						<div class="text-6xl mb-4">üì¶</div>
						<h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">No products found</h3>
						<p class="text-gray-600 dark:text-gray-400 mb-6">No products available in this category yet.</p>
						<a href="index.html" class="btn-primary">Browse All Products</a>
					</div>
				</div>
			</div>
		</div>
	</main>
	
	<div id="footer"></div>
	
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="assets/js/supabase.js"></script>
	<script src="assets/js/common.js"></script>
	<script src="assets/js/storage.js"></script>
	<script>
		let allProducts = [];
		let filteredProducts = [];
		
		function getCategory() {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get('category') || '';
		}
		
		function updateCategoryHeader(category) {
			const categoryEmojis = {
				'Electronics': 'üì±',
				'Books': 'üìö',
				'Fashion': 'üëï',
				'Furniture': 'ü™ë',
				'Home Goods': 'üè†',
				'Sports': '‚öΩ',
				'Toys': 'üß∏',
				'Miscellaneous': 'üîß',
				'Upcycled': '‚ôªÔ∏è'
			};
			
			const emoji = categoryEmojis[category] || 'üì¶';
			document.getElementById('categoryTitle').textContent = `${emoji} ${category}`;
			document.getElementById('categoryDescription').textContent = `Browse ${category.toLowerCase()} products`;
		}
		
		function card(p) {
			const isLoggedIn = window.eco?.auth?.isLoggedIn || false;
			const buttonClass = isLoggedIn ? "btn-primary text-sm" : "btn-primary text-sm opacity-50 cursor-not-allowed";
			const wishlistClass = isLoggedIn ? "btn-outline text-sm" : "btn-outline text-sm opacity-50 cursor-not-allowed";
			
			return `
			<div class="card bg-white dark:bg-gray-800 overflow-hidden group">
				<a href="product.html?id=${p.id}" class="block">
					<div class="relative overflow-hidden">
						<img src="${p.image || '/assets/images/placeholder.jpg'}" alt="${p.title}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"/>
						<div class="absolute top-3 right-3 flex gap-1">${badgeHtml(p.tags, p.price)}</div>
					</div>
					<div class="p-6">
						<div class="flex items-start justify-between mb-2">
							<h3 class="font-semibold text-gray-800 dark:text-gray-100 text-lg line-clamp-2">${p.title}</h3>
							<div class="text-green-500 font-bold text-xl ml-2">‚Çπ${p.price}</div>
						</div>
						<div class="text-sm text-gray-500 dark:text-gray-400 mb-3">${p.category || 'General'}</div>
						<div class="flex gap-2">
							<button data-add-cart="${p.id}" class="${buttonClass} flex-1" ${!isLoggedIn ? 'disabled' : ''}>
								<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m0 0h8.5M17 18a2 2 0 100 4 2 2 0 000-4zM9 18a2 2 0 100 4 2 2 0 000-4z"></path>
								</svg>
								Add to Cart
							</button>
							<button data-add-wl="${p.id}" class="${wishlistClass} px-3" ${!isLoggedIn ? 'disabled' : ''}>
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
								</svg>
							</button>
						</div>
					</div>
				</a>
			</div>`;
		}
		
		function badgeHtml(tags, price) {
			const parts = [];
			if (Array.isArray(tags) && tags.includes('Premium')) parts.push('<span class="badge badge-premium">Premium</span>');
			if (Array.isArray(tags) && tags.includes('New')) parts.push('<span class="badge badge-new">New</span>');
			if (price === 0) parts.push('<span class="badge badge-donation">Donation</span>');
			return parts.join(' ');
		}
		
		function filterByCategory(products, category) {
			return products.filter(p => p.category === category);
		}
		
		function applyFilters(products) {
			let filtered = [...products];
			
			// Sort filters
			const sortBy = document.querySelector('input[name="sort"]:checked')?.value;
			if (sortBy === 'new') {
				filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
			} else if (sortBy === 'age') {
				filtered.sort((a, b) => (a.age || '').localeCompare(b.age || ''));
			} else if (sortBy === 'rating') {
				// Mock rating sort
				filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
			} else if (sortBy === 'location') {
				filtered.sort((a, b) => (a.city || '').localeCompare(b.city || ''));
			}
			
			// Price filters
			const priceRange = document.querySelector('input[name="price"]:checked')?.value;
			if (priceRange) {
				if (priceRange === '0-500') {
					filtered = filtered.filter(p => Number(p.price) <= 500);
				} else if (priceRange === '500-1000') {
					filtered = filtered.filter(p => Number(p.price) > 500 && Number(p.price) <= 1000);
				} else if (priceRange === '1000-5000') {
					filtered = filtered.filter(p => Number(p.price) > 1000 && Number(p.price) <= 5000);
				} else if (priceRange === '5000+') {
					filtered = filtered.filter(p => Number(p.price) > 5000);
				}
			}
			
			return filtered;
		}
		
		function renderResults(products) {
			const resultsContainer = document.getElementById('categoryResults');
			const noResults = document.getElementById('noResults');
			
			if (products.length === 0) {
				resultsContainer.innerHTML = '';
				noResults.classList.remove('hidden');
			} else {
				noResults.classList.add('hidden');
				resultsContainer.innerHTML = `
					<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
						${products.map(card).join('')}
					</div>
				`;
			}
		}
		
		function setupFilters() {
			const filterInputs = document.querySelectorAll('input[name="sort"], input[name="price"]');
			filterInputs.forEach(input => {
				input.addEventListener('change', () => {
					filteredProducts = applyFilters(filterByCategory(allProducts, getCategory()));
					renderResults(filteredProducts);
				});
			});
			
			document.getElementById('clearFilters').addEventListener('click', () => {
				filterInputs.forEach(input => input.checked = false);
				filteredProducts = filterByCategory(allProducts, getCategory());
				renderResults(filteredProducts);
			});
		}
		
		function setupCartAndWishlist() {
			document.addEventListener('click', (e) => {
				const addCart = e.target.closest('[data-add-cart]');
				const addWl = e.target.closest('[data-add-wl]');
				
				if (addCart) {
					e.preventDefault();
					e.stopPropagation();
					if (!window.eco.auth.requireAuth('add to cart')) return;
					
					const id = addCart.getAttribute('data-add-cart');
					const item = allProducts.find(p => String(p.id) === String(id));
					if (item) {
						const cartItem = { 
							id: item.id, 
							title: item.title, 
							price: item.price, 
							image: item.image,
							category: item.category,
							seller_id: item.owner_id
						};
						window.eco.cart.add(cartItem);
						showToast('‚úÖ Item added to cart');
					}
				}
				
				if (addWl) {
					e.preventDefault();
					e.stopPropagation();
					if (!window.eco.auth.requireAuth('add to wishlist')) return;
					
					const id = addWl.getAttribute('data-add-wl');
					const item = allProducts.find(p => String(p.id) === String(id));
					if (item) {
						window.eco.wishlist.add({ 
							id: item.id, 
							title: item.title, 
							price: item.price, 
							image: item.image 
						});
						showToast('‚ù§Ô∏è Added to wishlist');
					}
				}
			});
		}
		
		function showToast(message) {
			const toast = document.createElement('div');
			toast.textContent = message;
			toast.className = 'toast';
			document.body.appendChild(toast);
			setTimeout(() => toast.remove(), 3000);
		}
		
		async function fetchProducts() {
			const { data, error } = await sb
				.from('products')
				.select('*')
				.order('created_at', { ascending: false });
			if (error) { console.error(error); return []; }
			return data || [];
		}
		
		(async function init() {
			await window.eco.auth.checkAuth();
			
			const category = getCategory();
			if (!category) {
				window.location.href = 'index.html';
				return;
			}
			
			updateCategoryHeader(category);
			allProducts = await fetchProducts();
			filteredProducts = filterByCategory(allProducts, category);
			
			renderResults(filteredProducts);
			setupFilters();
			setupCartAndWishlist();
			
			// Listen for auth state changes
			document.addEventListener('eco-auth-changed', () => {
				renderResults(filteredProducts);
			});
		})();
	</script>
</body>
</html>
