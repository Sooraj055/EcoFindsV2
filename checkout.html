<!doctype html>
<html lang="en" class="h-full">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>EcoFinds â€“ Checkout</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="assets/css/styles.css" />
	<script>
		tailwind.config = { 
			darkMode: 'class',
			theme: {
				extend: {
					colors: {
						eco: {
							green: '#2ECC71',
							dark: '#27AE60',
							gray: '#F8F9FA',
							text: '#2C3E50'
						}
					}
				}
			}
		};
	</script>
</head>
<body class="min-h-full bg-gray-50 text-gray-800" style="font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
	<div id="navbar"></div>
	
	<main class="container py-8">
		<div class="max-w-4xl mx-auto">
			<div class="flex items-center gap-3 mb-8">
				<div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
					<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
					</svg>
				</div>
				<h1 class="text-3xl font-bold text-gray-800">Checkout</h1>
			</div>
			
			<div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-8">
				<div class="flex items-start gap-3">
					<svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
					<div>
						<h3 class="font-semibold text-blue-800 mb-1">How it works</h3>
						<p class="text-sm text-blue-700">Contact the seller on WhatsApp to complete your purchase. This ensures secure transactions and direct communication.</p>
					</div>
				</div>
			</div>
			
			<div id="items" class="space-y-4 mb-8"></div>
			
			<div class="card bg-white p-6">
				<div class="flex items-center justify-between mb-4">
					<h3 class="text-lg font-semibold text-gray-800">Order Total</h3>
					<div id="total" class="text-2xl font-bold text-green-500">â‚¹0</div>
				</div>
				<div id="msg" class="text-sm text-gray-600"></div>
			</div>
		</div>
	</main>
	
	<div id="footer"></div>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
	<script src="assets/js/supabase.js"></script>
	<script src="assets/js/common.js"></script>
	<script src="assets/js/storage.js"></script>
	<script>
		function waLink(number, title, price){
			const text = encodeURIComponent(`Hello, I want to purchase ${title} for â‚¹${price}.\nPlease confirm the availability.`);
			const num = String(number||'').replace(/[^0-9]/g,'');
			return num ? `https://wa.me/${num}?text=${text}` : `https://wa.me/?text=${text}`;
		}
		async function loadSellerDetails(ids){
			if (!ids.length) return {};
			const { data, error } = await sb.from('products').select('id, whatsapp').in('id', ids);
			if (error) { console.warn(error); return {}; }
			const map = {}; (data||[]).forEach(r => { map[String(r.id)] = r.whatsapp; });
			return map;
		}
		function render(items, idToPhone){
			if (!items.length) {
				document.getElementById('items').innerHTML = `
					<div class="text-center py-16">
						<div class="text-6xl mb-4">ðŸ›’</div>
						<h3 class="text-xl font-semibold text-gray-800 mb-2">Your cart is empty</h3>
						<p class="text-gray-600 mb-6">Add some items to your cart to proceed with checkout.</p>
						<a href="index.html" class="btn-primary">Start Shopping</a>
					</div>
				`;
				return;
			}
			
			document.getElementById('items').innerHTML = items.map(i=>{
				const phone = idToPhone[String(i.id)] || '';
				const href = waLink(phone, i.title, i.price);
				const qrid = `qr_${i.id}`;
				
				return `
				<div class="card bg-white p-6">
					<div class="flex items-center gap-4 mb-4">
						<img src="${i.image || '/assets/images/placeholder.jpg'}" alt="${i.title}" class="w-20 h-20 object-cover rounded-lg"/>
						<div class="flex-1">
							<h3 class="font-semibold text-gray-800 mb-1">${i.title}</h3>
							<p class="text-sm text-gray-500 mb-2">${i.category || 'General'}</p>
							<div class="text-lg font-bold text-green-500">â‚¹${i.price}</div>
						</div>
						<a href="${href}" target="_blank" class="btn-primary">
							<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
							</svg>
							Contact Seller
						</a>
					</div>
					
					<div class="bg-gray-50 rounded-lg p-4">
						<div class="flex items-center gap-2 mb-2">
							<svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
							</svg>
							<span class="text-sm text-gray-600">QR Code (if WhatsApp doesn't work):</span>
						</div>
						<div id="${qrid}" class="inline-block p-2 bg-white rounded-lg"></div>
					</div>
				</div>`;
			}).join('');
			
			// Generate QR codes
			items.forEach(i=>{
				const phone = idToPhone[String(i.id)] || '';
				const href = waLink(phone, i.title, i.price);
				const el = document.getElementById(`qr_${i.id}`);
				if (el) { 
					el.innerHTML = ''; 
					new QRCode(el, { text: href, width: 120, height: 120 }); 
				}
			});
			
			const total = items.reduce((s,x)=> s + Number(x.price||0), 0);
			document.getElementById('total').textContent = 'â‚¹' + total;
			const saved = (items.length * 2).toFixed(1);
			document.getElementById('msg').innerHTML = `
				<div class="flex items-center gap-2">
					<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
					</svg>
					<span>You saved <strong>${saved} kg COâ‚‚e</strong> by buying second-hand!</span>
				</div>
			`;
		}
		(async function init(){
			// Wait for auth state to be checked
			await window.eco.auth.checkAuth();
			
			if (!window.eco.auth.isLoggedIn) {
				document.getElementById('items').innerHTML = '<div class="text-center text-zinc-400">Please login to view checkout.</div>';
				return;
			}
			
			const items = window.eco.cart.get();
			const ids = items.map(i=>i.id);
			const idToPhone = await loadSellerDetails(ids);
			render(items, idToPhone);
		})();
	</script>
</body>
</html>
